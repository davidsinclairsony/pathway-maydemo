!function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";var IntroView=require("./app/views/intro"),HelloView=require("./app/views/hello"),ConversationView=require("./app/views/conversation"),Router=require("./app/router");module.exports=Backbone.View.extend({el:"#app",initialize:function(){var self=this;this.router=new Router,this.router.on("route:intro",function(){var view=new IntroView;self.goTo(view),self.listenToOnce(view,"end",function(){self.router.navigate("hello",{trigger:!0})})}),this.router.on("route:hello",function(){var view=new HelloView;self.goTo(view),self.listenToOnce(view,"end",function(){self.router.navigate("conversation",{trigger:!0})})}),this.router.on("route:conversation",function(){var conversationView=new ConversationView;self.goTo(conversationView)}),Backbone.history.start({pushState:!0})},events:{"click .refresh":"refresh"},refresh:function(){window.location.replace("/")},goTo:function(view){var self=this,previous=this.currentView||null,next=view;previous&&TweenMax.to(previous.$el,.5,{opacity:0,onComplete:function(){previous.remove()}}),self.currentView=next,self.$el.append(next.el),next.$el.hide(),self.listenToOnce(next,"loaded",function(){next.$el.waitForImages(function(){self.$el.removeClass("spinner").addClass("spinOut"),next.$el.show(),TweenMax.from(next.$el,.5,{opacity:0})})})}})},{"./app/router":6,"./app/views/conversation":7,"./app/views/hello":14,"./app/views/intro":15}],2:[function(require,module,exports){"use strict";var PersonModel=require("../models/person");module.exports=Backbone.Collection.extend({model:PersonModel})},{"../models/person":4}],3:[function(require,module,exports){"use strict";var QuestionModel=require("../models/question");module.exports=Backbone.Collection.extend({model:QuestionModel})},{"../models/question":5}],4:[function(require,module,exports){"use strict";module.exports=Backbone.Model.extend({})},{}],5:[function(require,module,exports){arguments[4][4][0].apply(exports,arguments)},{dup:4}],6:[function(require,module,exports){"use strict";module.exports=Backbone.Router.extend({routes:{"":"intro",hello:"hello",conversation:"conversation","*error":"error"}})},{}],7:[function(require,module,exports){"use strict";var PeopleView=require("./conversation/people"),QuestionsView=require("./conversation/questions"),ResponseView=require("./conversation/response");module.exports=Backbone.View.extend({className:"view conversation",initialize:function(){this.render(),this.peopleView=new PeopleView,this.$el.append(this.peopleView.el),this.questionsView=new QuestionsView,this.$el.append(this.questionsView.el),this.responseView=new ResponseView,this.$el.append(this.responseView.el)},render:function(){var self=this;return $.get("/templates/conversation.html",function(data){self.$el.append(data),self.$el.hammer({domEvents:!0}),self.trigger("loaded")}),self},events:{"click .ask":"askAnotherQuestion","click .how, footer .close":"howToggler",revealAllQuestions:"askAnotherQuestion",hidAllExceptSelectedQuestion:"prepareForResponse",revealedAllQuestions:"hideResponse",dataSourced:"getAndShowResponse",panstart:"panHandler",pan:"panHandler",swiped:"swipeHandler"},panHandler:function(e){!e.originalEvent||$(e.target).parents(".response").length||$(e.target).hasClass("response")||$(e.target).parents(".modal").length||$(e.target).hasClass("modal")||this.peopleView.panHandler(e)},swipeHandler:function(event,objects){this.peopleView.swipeHandler(objects.event),this.questionsView.selectedQuestion&&(this.responseView.setToLoading(),this.prepareForResponse())},howToggler:function(){var $know=this.$(".know");$know.toggleClass("off",$know.hasClass("on")),$know.toggleClass("on",!$know.hasClass("on"))},askAnotherQuestion:function(){this.questionsView.revealAllQuestions()},prepareForResponse:function(){this.responseView.prepare(this.questionsView.selectedQuestion),TweenMax.to(this.$(".lower"),.5,{opacity:1}),this.peopleView.selectedPerson.obtainData()},getAndShowResponse:function(){this.stopListening(this.responseView,"answerReady"),this.responseView.jqxhr&&this.responseView.jqxhr.abort(),this.responseView.timeout&&clearTimeout(this.responseView.timeout),this.listenToOnce(this.responseView,"answerReady",function(){this.peopleView.selectedPerson&&this.questionsView.selectedQuestion&&this.peopleView.selectedPerson.cid==this.responseView.answer.cid&&this.questionsView.selectedQuestion.model.get("id")==this.responseView.answer.questionID&&this.responseView.show()}),this.responseView.get(this.peopleView.selectedPerson,this.questionsView.selectedQuestion)},hideResponse:function(){this.responseView.hide(),TweenMax.to(this.$(".lower"),.5,{opacity:0})}})},{"./conversation/people":8,"./conversation/questions":10,"./conversation/response":13}],8:[function(require,module,exports){"use strict";var PeopleCollection=require("../../collections/people"),PersonView=require("./people/person");module.exports=Backbone.View.extend({className:"people",tagName:"ul",swipeThreshold:125,initialize:function(){var self=this;$.getJSON("/scripts/json/people.js",function(data){self.peopleCollection=new PeopleCollection(data),self.views=[],self.views.push(new PersonView({model:self.peopleCollection.first()})),self.setSelectedPerson(self.views[0]),self.render()})},render:function(){return this.$el.html(this.views[0].el),this.pad(),this.positionLeft=-1196,self},setSelectedPerson:function(view){this.selectedPerson&&(this.selectedPerson.selected=!1),this.selectedPerson=view,view.selected=!0},pad:function(){for(var modelIndex,model,view,indexOfSelectedPerson=this.views.indexOf(this.selectedPerson);2>indexOfSelectedPerson;)modelIndex=this.peopleCollection.indexOf(this.views[0].model),model=0===modelIndex?this.peopleCollection.last():this.peopleCollection.at(modelIndex-1),view=new PersonView({model:model}),this.views.unshift(view),this.$el.prepend(view.el),indexOfSelectedPerson=this.views.indexOf(this.selectedPerson);for(;this.views.length<5;)modelIndex=this.peopleCollection.indexOf(_.last(this.views).model),model=modelIndex==_.size(this.peopleCollection)-1?this.peopleCollection.first():this.peopleCollection.at(modelIndex+1),view=new PersonView({model:model}),this.views.push(view),this.$el.append(view.el)},panHandler:function(e){var self=this;if(e.originalEvent.gesture.isFinal)e.originalEvent.gesture.deltaX<-self.swipeThreshold||e.originalEvent.gesture.deltaX>self.swipeThreshold?self.$el.trigger("swiped",{event:e}):TweenMax.to(self.$el,.1,{left:self.positionLeft});else{var left=self.positionLeft+e.originalEvent.gesture.deltaX;self.$el.css({left:left})}},swipeHandler:function(e){var self=this,currentIndex=self.views.indexOf(self.selectedPerson);e.originalEvent.gesture.deltaX<0?(self.setSelectedPerson(self.views[currentIndex+1]),TweenMax.to(self.$el,.1,{left:self.positionLeft-640,onComplete:function(){_.first(self.views).remove(),self.views.shift(),self.pad(),self.$("> li:first-child").css({marginLeft:0}),self.$("> li:nth-child(n + 2)").css({marginLeft:"40px"}),self.$el.css({left:self.positionLeft})}})):(self.setSelectedPerson(self.views[currentIndex-1]),TweenMax.to(self.$el,.1,{left:self.positionLeft+640,onComplete:function(){_.last(self.views).remove(),self.views.pop(),self.pad(),self.$("> li:first-child").css({marginLeft:0}),self.$("> li:nth-child(n + 2)").css({marginLeft:"40px"}),self.$el.css({left:self.positionLeft})}}))}})},{"../../collections/people":2,"./people/person":9}],9:[function(require,module,exports){"use strict";module.exports=Backbone.View.extend({tagName:"li",initialize:function(){var self=this;$.get("/templates/conversation/people/person.html",function(data){self.template=_.template(data),self.render()}),$.get("/templates/conversation/people/person/modal.html",function(data){self.modalTemplate=_.template(data)})},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},events:{"click .picture":"popupHandler","click .sources li":"popupHandler","click .popup button":"reportToggler","click .modal button":"reportToggler"},reportToggler:function(){var $modal=this.$el.find(".modal");$modal.length?TweenMax.to($modal,.5,{opacity:0,onComplete:function(){$modal.remove()}}):(this.$el.append(this.modalTemplate(this.model.toJSON())),$modal=this.$(".modal"),$modal.waitForImages(function(){$modal.removeClass("spinner").addClass("spinOut"),TweenMax.fromTo($modal.find("> div"),.5,{opacity:0,visibility:"visible"},{opacity:1,onComplete:function(){$modal.removeClass("spinOut")}})}),$modal.on("touchstart mousedown click",function(e){$(e.target).is($modal.find("button"))||e.stopImmediatePropagation()}))},obtainData:function(){var self=this;self.$("li.available").each(function(){var $this=$(this);$this.removeClass("spinOut").addClass("spinner"),setTimeout(function(){$this.removeClass("spinner").addClass("spinOut")},Math.floor(2e3*Math.random()+1e3))}),self.$el.trigger("dataSourced")},popupHandler:function(e){if(this.selected){e.stopImmediatePropagation();var self=this,$newPopup=$(e.target).siblings(".popup");if(self.$popup){var isSameAsCurrent=self.$popup.is($newPopup);this.popupRemover(self.$popup),isSameAsCurrent||(self.$popup=$newPopup,this.popupShower(self.$popup))}else this.popupShower($newPopup)}},popupRemover:function($p){this.$popup=null,TweenMax.to($p,.5,{opacity:0,display:"none",overwrite:"all"}),$("body").off("touchend click")},popupShower:function($p){var self=this;self.$popup=$p,TweenMax.fromTo($p,.5,{opacity:0,display:"block"},{opacity:1,overwrite:"all"}),$("body").one("touchend click",function(){self.popupRemover($p)})}})},{}],10:[function(require,module,exports){"use strict";var QuestionModel=require("../../models/question"),QuestionsCollection=require("../../collections/questions"),QuestionView=require("./questions/question"),CustomQuestionView=require("./questions/customQuestion");module.exports=Backbone.View.extend({className:"questions",tagName:"ul",initialize:function(){var self=this;$.getJSON("/scripts/json/questions.js",function(data){self.questionsCollection=new QuestionsCollection(data),self.views=[],self.questionsCollection.each(function(model){self.views.push(new QuestionView({model:model}))}),self.views.push(new CustomQuestionView({model:new QuestionModel})),self.render()})},render:function(){var self=this;self.$el.empty();var container=document.createDocumentFragment();return _.each(self.views,function(view){container.appendChild(view.el)}),self.$el.append(container),self},events:{questionClicked:"questionClicked",regenerateCustomQuestion:"regenerateCustomQuestion"},questionClicked:function(event,objects){this.selectedQuestion?this.$el.trigger("revealAllQuestions"):(this.selectedQuestion=objects.selectedQuestion,this.hideAllExceptSelectedQuestion())},hideAllExceptSelectedQuestion:function(){var self=this;self.$el.trigger("hidAllExceptSelectedQuestion"),_.each(this.views,function(view){if(view==self.selectedQuestion){var currentOffset=view.$el.offset();view.$el.css("position","absolute");var desiredOffset=view.$el.offset();view.$el.css("position","relative"),TweenMax.to(view.$el,.5,{top:desiredOffset.top-currentOffset.top})}else TweenMax.to(view.$el,.5,{autoAlpha:0})})},revealAllQuestions:function(){var self=this;self.selectedQuestion&&(self.$el.trigger("revealedAllQuestions"),_.each(this.views,function(view){view instanceof CustomQuestionView&&view.stale(),view==self.selectedQuestion?(self.selectedQuestion=null,view.$el.is(":first-child")||TweenMax.to(view.$el,.5,{top:0,onComplete:function(){view instanceof CustomQuestionView&&self.regenerateCustomQuestion()}})):TweenMax.to(view.$el,.5,{autoAlpha:1})}))},regenerateCustomQuestion:function(){var self=this,current=self.views.slice(-1)[0];current.$el.css({position:"absolute",top:current.$el.position().top,left:current.$el.position().left,width:current.$el.outerWidth(),zIndex:10});var view=new CustomQuestionView({model:new QuestionModel});self.$el.append(view.el);var i=setInterval(function(){jQuery.contains(self.el,view.el)&&(clearInterval(i),current.remove(),self.views.pop(),self.views.push(view))},1)}})},{"../../collections/questions":3,"../../models/question":5,"./questions/customQuestion":11,"./questions/question":12}],11:[function(require,module,exports){"use strict";module.exports=Backbone.View.extend({tagName:"li",className:"custom",status:"stale",initialize:function(){this.render()},render:function(){var self=this;return $.get("/templates/conversation/questions/custom.html",function(data){self.$el.append(data),self.$input=self.$("input"),self.$button=self.$("button"),self.$button.css("display","none")}),this},events:{click:"router","keyup input":"keyHandler"},router:function(e){$(e.target).is(this.$button)&&""!==this.$input.val()?this.selected():"selected"==this.status?this.$el.trigger("questionClicked",{selectedQuestion:this}):this.editing()},keyHandler:function(e){13==e.keyCode&&this.$button.click()},editing:function(){var self=this;self.status="editing",self.$input.prop("readonly",!1).focus(),self.$el.hasClass("focused")||(TweenMax.to(self.$el,.5,{className:"+=focused"}),TweenMax.fromTo(self.$button,.5,{opacity:0,display:"block"},{opacity:1}))},selected:function(){var self=this;self.status="selected",self.model.set({text:self.$input.val()}),self.$input.blur().prop("readonly",!0),self.shrink(),self.$el.trigger("questionClicked",{selectedQuestion:self})},stale:function(){this.$input.val(""),"editing"==this.status&&this.shrink(),this.status="stale"},shrink:function(){var self=this;TweenMax.to(self.$el,.5,{className:"-=focused"}),TweenMax.to(self.$button,.5,{opacity:0,display:"none"})}})},{}],12:[function(require,module,exports){"use strict";module.exports=Backbone.View.extend({tagName:"li",template:_.template("<%= text %>"),initialize:function(){this.render()},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},events:{click:"clicked"},clicked:function(){this.$el.trigger("questionClicked",{selectedQuestion:this})}})},{}],13:[function(require,module,exports){"use strict";var config=require("../../../config");module.exports=Backbone.View.extend({className:"response",initialize:function(){var self=this,a1=$.getJSON("/scripts/json/genes.js"),a2=$.getJSON("/scripts/json/answers.js"),a3=$.get("/templates/conversation/response/genes.html");$.when(a1,a2,a3).done(function(r1,r2,r3){self.genes=r1[0],self.answers=r2[0],self.genesTemplate=_.template(r3[0]),self.render(),self.setToLoading()})},render:function(){return this.setToLoading(),this.$el.hide(),this},events:{"click footer div:nth-last-child(-n + 2)":"markRated"},markRated:function(e){$(e.currentTarget).parent().find("div").removeClass("clicked"),$(e.currentTarget).addClass("clicked")},setToLoading:function(){this.$el.empty().addClass("spinner").removeClass("spinOut").removeClass("has-map").removeClass("has-genes")},prepare:function(answer){var self=this,top=answer.$el.parent().offset().top+58+10,height=462;self.$el.css({display:"block",top:top,height:height}),TweenMax.fromTo(self.$el,.5,{opacity:0},{opacity:1,overwrite:"all"})},get:function(person,question){var requestData,self=this;self.answer={},self.answer.cid=person.cid,self.answer.personID=person.model.get("id"),self.answer.questionID=question.model.get("id"),self.answer.html="";var numberWithCommas=function(x){return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")};if([1,2,3].indexOf(self.answer.questionID)>-1&&(self.answer.genes=self.genesTemplate(self.genes[question.model.get("genes")])),self.answer.questionID<4){var html="";switch(self.answer.questionID){case 1:requestData={userId:self.answer.personID,fitness:"true"},self.jqxhr=$.ajax({url:config.url,data:requestData,dataType:"jsonp",timeout:3e3}).always(function(data,status,jqxhr){if("success"==status&&0===data.fitness.code){var randomResponse,randomNumber=Math.floor(6*Math.random());4!=randomNumber?randomResponse=self.answers[0].responses[randomNumber]:(randomResponse=self.answers[0].responses[randomNumber][0]+self.answers[0].locations[self.answer.personID-1].title+self.answers[0].responses[randomNumber][1]+self.answers[0].locations[self.answer.personID-1].address+self.answers[0].responses[randomNumber][2],self.answer.locations=[self.answers[0].locations[self.answer.personID-1]]),html=person.model.get("name")+self.answers[0].parts[0]+"<span class='highlight'>"+numberWithCommas(data.fitness.summary.caloriesOut)+"</span>"+self.answers[0].parts[1]+person.model.get("goals")+self.answers[0].parts[2]+randomResponse,self.answer.html=html}else self.answer.html="<p>Sorry, please try again.</p>";self.timeout=setTimeout(function(){self.trigger("answerReady")},2500)});break;case 2:self.answer.html=self.answers[1][self.answer.personID-1].html;var locations=self.answers[1][self.answer.personID-1].locations;self.answer.html+="<ul>";for(var i=0;i<locations.length;i++)self.answer.html+="<li>"+locations[i].title+"</li>";self.answer.html+="</ul>",self.answer.locations=locations,self.timeout=setTimeout(function(){self.trigger("answerReady")},3e3);break;case 3:self.answer.html=self.answers[2][self.answer.personID-1],self.timeout=setTimeout(function(){self.trigger("answerReady")},3e3)}}else requestData={userId:1,question:{questionText:question.model.get("text")}},self.jqxhr=$.ajax({url:config.url,data:requestData,dataType:"jsonp",timeout:15e3}).always(function(data,status,jqxhr){"success"==status&&data.answer.answers[0]?(5==self.answer.questionID&&2==self.answer.personID&&(self.answer.html+=self.answers[3]),self.answer.html+=data.answer.answers[0].formattedText):self.answer.html="<p>Sorry, please try again.</p>",self.trigger("answerReady")})},show:function(){var self=this;self.$el.removeClass("spinner").addClass("spinOut"),self.$el.append(self.answer.html?"<main>"+self.answer.html+"</main>":"<main><p>Sorry, please try again later.</p></main>"),self.answer.genes&&(self.$el.addClass("has-genes"),self.$el.append(self.answer.genes)),self.answer.locations&&(self.$el.addClass("has-map"),self.$el.append("<div class='container'><div id='map'></div></div>"),$.getJSON("/scripts/json/map.js",function(styles){var styledMap=new google.maps.StyledMapType(styles,{name:"Styled"}),mapOptions={mapTypeControlOptions:{mapTypeIds:[google.maps.MapTypeId.ROADMAP,"map_style"]},mapTypeControl:!1,streetViewControl:!1,zoomControl:!0,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE,position:google.maps.ControlPosition.LEFT_TOP}},map=new google.maps.Map(document.getElementById("map"),mapOptions);map.mapTypes.set("map_style",styledMap),map.setMapTypeId("map_style");for(var bounds=new google.maps.LatLngBounds,infowindow=new google.maps.InfoWindow,i=0;i<self.answer.locations.length;i++){var content="";self.answer.locations[i].title&&(content="<div class='title'>"+self.answer.locations[i].title+"</div>"),self.answer.locations[i].description&&(content+="<div class='description'>"+self.answer.locations[i].description+"</div>");var marker=new google.maps.Marker({position:new google.maps.LatLng(self.answer.locations[i].coordinates.lattitude,self.answer.locations[i].coordinates.longitude),map:map,title:content,visible:!0});bounds.extend(marker.position),google.maps.event.addListener(marker,"click",function(marker,i){return function(){infowindow.setContent(marker.title),infowindow.open(map,marker)}}(marker,i))}if(map.fitBounds(bounds),self.answer.locations.length<2)var listener=google.maps.event.addListener(map,"idle",function(){map.setZoom(11),google.maps.event.removeListener(listener)})})),$.get("/templates/conversation/response/footer.html",function(data){self.$el.append(data)})},hide:function(){var self=this;TweenMax.fromTo(self.$el,.5,{opacity:1},{opacity:0,display:"none",onComplete:function(){self.setToLoading()}})}})},{"../../../config":16}],14:[function(require,module,exports){"use strict";module.exports=Backbone.View.extend({className:"view hello",initialize:function(){var self=this;self.render(),self.$el.one("click","button",function(){self.trigger("end")})},render:function(){var self=this;return self.$el.load("/templates/hello.html",function(){self.trigger("loaded")}),self}})},{}],15:[function(require,module,exports){"use strict";module.exports=Backbone.View.extend({className:"view intro",initialize:function(){var self=this;self.render(),setTimeout(function(){self.trigger("end")},7e3)},render:function(){var self=this;return self.$el.load("/templates/intro.html",function(){self.trigger("loaded")}),self}})},{}],16:[function(require,module,exports){"use strict";module.exports={url:"http://"+window.location.host+"/ask"}},{}],17:[function(require,module,exports){"use strict";var AppView=require("./app");$(window).load(function(){var resetTimer=function(t){0===t&&clearTimeout(timer),t>90||(t++,timer=setTimeout(function(){resetTimer(t)},1e3))},timer=setTimeout(function(){resetTimer(0)},1e3);$(document).on("touchstart mousedown",function(e){$(this).preventScrolling(e),resetTimer(0)}),FastClick.attach(document.body),window.app=new AppView})},{"./app":1}]},{},[17]);